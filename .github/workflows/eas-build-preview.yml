name: ğŸš€ EAS Build Preview (Develop)

on:
  push:
    branches:
      - develop
    paths:
      - 'stockup/**'
      - '.github/workflows/eas-build-preview.yml'
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  build:
    name: Build Android Preview APK
    runs-on: ubuntu-latest
    permissions:
      contents: write # Pour crÃ©er des releases
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: stockup/package-lock.json

      - name: ğŸ“¦ Install dependencies
        working-directory: ./stockup
        run: npm ci

      - name: ğŸ—ï¸ Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸš€ Build Android APK
        working-directory: ./stockup
        run: |
          # Lance le build et capture l'output
          eas build -p android --profile preview --non-interactive > build_output.txt 2>&1
          cat build_output.txt
        id: build

      - name: ğŸ“‹ Get Build Details
        id: build-info
        working-directory: ./stockup
        run: |
          # Attendre quelques secondes pour que le build soit enregistrÃ©
          sleep 5
          
          # RÃ©cupÃ¨re les infos du dernier build
          BUILD_DATA=$(eas build:list --platform android --limit 1 --json --non-interactive 2>/dev/null || echo "[]")
          
          if [ "$BUILD_DATA" != "[]" ] && [ ! -z "$BUILD_DATA" ]; then
            BUILD_ID=$(echo "$BUILD_DATA" | jq -r '.[0].id // ""')
          else
            BUILD_ID=""
          fi
          
          # CrÃ©e les URLs
          OWNER=$(jq -r '.expo.owner // "baptiste-ntr"' app.json)
          SLUG=$(jq -r '.expo.slug // "stockup"' app.json)
          
          if [ ! -z "$BUILD_ID" ]; then
            EXPO_URL="https://expo.dev/accounts/${OWNER}/projects/${SLUG}/builds/${BUILD_ID}"
          else
            EXPO_URL="https://expo.dev/accounts/${OWNER}/projects/${SLUG}/builds"
          fi
          
          echo "expo_url=${EXPO_URL}" >> $GITHUB_OUTPUT
          echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
          echo "owner=${OWNER}" >> $GITHUB_OUTPUT
          echo "slug=${SLUG}" >> $GITHUB_OUTPUT

      - name: ğŸ·ï¸ Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: preview-${{ github.sha }}
          name: "ğŸ“± Preview Build - ${{ github.event.head_commit.message }}"
          body: |
            ## ğŸ‰ Nouveau build preview en cours !
            
            **Branche:** `develop`
            **Commit:** `${{ github.sha }}`
            **Message:** ${{ github.event.head_commit.message }}
            
            ### ğŸ“² Installation
            
            Le build est en cours de gÃ©nÃ©ration sur EAS. Une fois terminÃ© (environ 10-15 minutes), vous pourrez tÃ©lÃ©charger l'APK ici :
            
            ğŸ”— **[Voir le build sur Expo](${{ steps.build-info.outputs.expo_url }})**
            
            ### â„¹ï¸ Informations du build
            
            - **Projet:** `${{ steps.build-info.outputs.owner }}/${{ steps.build-info.outputs.slug }}`
            - **Plateforme:** Android (APK)
            - **Profile:** preview
            - **Build ID:** ${{ steps.build-info.outputs.build_id || 'En cours...' }}
            
            ### ğŸ“ Comment tÃ©lÃ©charger
            
            1. Cliquez sur le lien ci-dessus
            2. Attendez que le build soit terminÃ© (statut "Finished")
            3. Scannez le QR code ou cliquez sur "Download" pour obtenir l'APK
            4. Installez l'APK sur votre appareil Android
            
            ---
            
            _Build lancÃ© automatiquement par GitHub Actions_
          draft: false
          prerelease: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ’¬ Comment on Commit
        uses: peter-evans/commit-comment@v3
        with:
          body: |
            ## âœ… Build Preview LancÃ© !
            
            ğŸš€ **Statut du build:** ${{ steps.build-info.outputs.expo_url }}
            
            Le build est en cours de gÃ©nÃ©ration sur EAS. Consultez la release GitHub pour obtenir le lien de tÃ©lÃ©chargement une fois le build terminÃ©.

